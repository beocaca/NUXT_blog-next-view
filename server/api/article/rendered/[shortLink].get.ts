import { ArticleSchema } from '~/server/models/article.schema'
import { useMarkdownParser } from '~/composables/useMarkdownParser'
import { storage } from '~/config/unstorage.config'
import zlib from 'node:zlib'

export default defineEventHandler(async (event) => {
  try {
    const shortLink = event.context.params?.shortLink
    const parse = useMarkdownParser()
    let json = undefined
    if (shortLink) {

      const result = await storage.getItem(shortLink)
      if (result) {
        console.warn('= recover from cache:', shortLink)
        json = result
      }
      else {
        const queryres = (await ArticleSchema.findOne(
          { shortLink },
          { content: 1 },
        )) as { _id: string, content: string }

        if (!queryres)
          return new Response('404 Not Found', { status: 404 })

        const { content } = queryres

        const start = performance.now()
        const html = await parse(content)
        const end = performance.now()
        const executionTime = Math.round(end - start)
        console.warn(`+ render html for [${shortLink}] takes [${executionTime}] ms`)
        storage.setItem(shortLink, html)
        json = html
      }

      const jsonData = JSON.stringify(json)
      const compressedData = zlib.gzipSync(jsonData)
      const headers = new Headers()
      headers.set('Content-Encoding', 'gzip')
      headers.set('Content-Length', compressedData.length.toString())
      return new Response(compressedData, {
        headers
      })
    }
  }
  catch (error) {
    return new Response(error as string, { status: 500 })
  }
})
